name: ğŸš€ Release

permissions:
  contents: write
  actions: write
  attestations: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.5.0)'
        required: true
        type: string

jobs:
  validate-inputs:
    name: ğŸ” Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: ğŸ” Validate version format
        id: validate
        run: |
          version="${{ github.event.inputs.version }}"
          
          # Check if version starts with 'v' and follows semantic versioning
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Version must follow semantic versioning format (e.g., v1.5.0)"
            exit 1
          fi
          
          echo "âœ… Version format is valid: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

  discover-backends:
    name: ğŸ” Discover Backends
    runs-on: ubuntu-latest
    needs: validate-inputs
    outputs:
      backends: ${{ steps.discover.outputs.backends }}
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Discover backends
        id: discover
        run: |
          # Find all backend directories that have go.mod files
          backends=$(find backend -mindepth 1 -maxdepth 1 -type d | sort)
          
          # Filter to only include directories with go.mod files
          backend_list=()
          for backend in $backends; do
            if [[ -f "$backend/go.mod" ]]; then
              backend_name=$(basename "$backend")
              backend_list+=("$backend_name")
              echo "âœ… Found backend: $backend_name"
            fi
          done
          
          # Convert to JSON array
          backends_json=$(printf '%s\n' "${backend_list[@]}" | jq -R . | jq -s . | jq -c .)
          echo "backends=$backends_json" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Discovered backends: $backends_json"

  create-tags:
    name: ğŸ·ï¸ Create and Push Tags
    runs-on: ubuntu-latest
    needs: [validate-inputs, discover-backends]
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Create main project tag
        run: |
          version="${{ needs.validate-inputs.outputs.version }}"
          
          # Check if tag already exists
          if git tag -l | grep -q "^${version}$"; then
            echo "âš ï¸ Tag $version already exists for main project"
          else
            git tag "$version"
            echo "âœ… Created main project tag: $version"
          fi

      - name: ğŸ·ï¸ Create backend tags
        run: |
          version="${{ needs.validate-inputs.outputs.version }}"
          backends='${{ needs.discover-backends.outputs.backends }}'
          
          echo "Creating backend tags for version: $version"
          
          # Parse backends JSON array
          echo "$backends" | jq -r '.[]' | while read -r backend; do
            backend_tag="backend/${backend}/${version}"
            
            # Check if tag already exists
            if git tag -l | grep -q "^${backend_tag}$"; then
              echo "âš ï¸ Tag $backend_tag already exists"
            else
              git tag "$backend_tag"
              echo "âœ… Created backend tag: $backend_tag"
            fi
          done

      - name: ğŸš€ Push all tags
        run: |
          version="${{ needs.validate-inputs.outputs.version }}"
          
          echo "Pushing main project tag..."
          git push origin "$version" || echo "âš ï¸ Main project tag $version may already exist remotely"
          
          echo "Pushing backend tags..."
          backends='${{ needs.discover-backends.outputs.backends }}'
          echo "$backends" | jq -r '.[]' | while read -r backend; do
            backend_tag="backend/${backend}/${version}"
            git push origin "$backend_tag" || echo "âš ï¸ Backend tag $backend_tag may already exist remotely"
            echo "ğŸ“¤ Pushed: $backend_tag"
          done
          
          echo "ğŸ‰ All tags pushed successfully!"

  deploy-docs:
    name: ğŸ“šğŸš€ Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: [validate-inputs, create-tags]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd website
          npm ci

      - name: ğŸ“š Create versioned documentation
        run: |
          cd website
          version="${{ needs.validate-inputs.outputs.version }}"
          # Remove 'v' prefix for Docusaurus version
          doc_version=${version#v}
          
          echo "Creating versioned documentation for version: $doc_version"
          
          # Check if this version already exists
          if [[ -f versions.json ]] && jq -e ". | index(\"$doc_version\")" versions.json > /dev/null; then
            echo "â„¹ï¸ Version $doc_version already exists, skipping versioning"
          else
            # Use Docusaurus versioning command to create the version
            npm run version "$doc_version"
            echo "âœ… Created version $doc_version using Docusaurus versioning"
          fi
          
          # Show current versions
          if [[ -f versions.json ]]; then
            echo "ğŸ“‹ Current versions:"
            cat versions.json
          fi

      - name: ğŸ“ Update Docusaurus current version label
        run: |
          cd website
          version="${{ needs.validate-inputs.outputs.version }}"
          doc_version=${version#v}
          # Remplace la valeur de lastVersion dans docusaurus.config.ts
          sed -i.bak -E "s/(lastVersion:\s*')[^']+(',)/\1${doc_version}\2/" docusaurus.config.ts
          rm docusaurus.config.ts.bak

      - name: ğŸ—ï¸ Build website
        run: |
          cd website
          npm run build

      - name: ğŸ—‚ï¸ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: website/build

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“š Commit documentation version
        run: |
          cd website
          version="${{ needs.validate-inputs.outputs.version }}"
          doc_version=${version#v}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/${doc_version} versions.json
          git commit -m "docs: add documentation for version ${doc_version}" || echo "No changes to commit"
          git push origin main