name: ğŸš€ Release

permissions:
  contents: write
  actions: write
  attestations: write

"on":
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.5.0)'
        required: true
        type: string
      release_type:
        description: 'What to release'
        required: true
        type: choice
        default: 'core+backends'
        options:
          - 'core'
          - 'backends'
          - 'core+backends'
      latest:
        description: 'Mark this release as latest'
        required: false
        type: boolean
        default: false
      publish_docs:
        description: 'Publish documentation'
        required: false
        type: boolean
        default: true

jobs:
  validate-inputs:
    name: ğŸ” Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      release_type: ${{ steps.validate.outputs.release_type }}
      latest: ${{ steps.validate.outputs.latest }}
      publish_docs: ${{ steps.validate.outputs.publish_docs }}
    steps:
      - name: ğŸ” Validate version format
        id: validate
        run: |
          version="${{ github.event.inputs.version }}"
          release_type="${{ github.event.inputs.release_type }}"
          latest="${{ github.event.inputs.latest }}"
          publish_docs="${{ github.event.inputs.publish_docs }}"
          
          # Check if version starts with 'v' and follows semantic versioning
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Version must follow semantic versioning format (e.g., v1.5.0)"
            exit 1
          fi
          
          echo "âœ… Version format is valid: $version"
          echo "ğŸ“¦ Release type: $release_type"
          echo "ğŸ·ï¸ Mark as latest: $latest"
          echo "ğŸ“š Publish documentation: $publish_docs"
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "release_type=$release_type" >> $GITHUB_OUTPUT
          echo "latest=$latest" >> $GITHUB_OUTPUT
          echo "publish_docs=$publish_docs" >> $GITHUB_OUTPUT

  discover-backends:
    name: ğŸ” Discover Backends
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: ${{ needs.validate-inputs.outputs.release_type == 'backends' || needs.validate-inputs.outputs.release_type == 'core+backends' }}
    outputs:
      backends: ${{ steps.discover.outputs.backends }}
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Discover backends
        id: discover
        run: |
          # Find all backend directories that have go.mod files
          backends=$(find backend -mindepth 1 -maxdepth 1 -type d | sort)
          
          # Filter to only include directories with go.mod files
          backend_list=()
          for backend in $backends; do
            if [[ -f "$backend/go.mod" ]]; then
              backend_name=$(basename "$backend")
              backend_list+=("$backend_name")
              echo "âœ… Found backend: $backend_name"
            fi
          done
          
          # Convert to JSON array
          backends_json=$(printf '%s\n' "${backend_list[@]}" | jq -R . | jq -s . | jq -c .)
          echo "backends=$backends_json" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Discovered backends: $backends_json"

  create-tags:
    name: ğŸ·ï¸ Create and Push Tags
    runs-on: ubuntu-latest
    needs: [validate-inputs, discover-backends]
    if: always() && !cancelled() && !failure()
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Create main project tag
        if: ${{ needs.validate-inputs.outputs.release_type == 'core' || needs.validate-inputs.outputs.release_type == 'core+backends' }}
        run: |
          version="${{ needs.validate-inputs.outputs.version }}"
          
          # Check if tag already exists
          if git tag -l | grep -q "^${version}$"; then
            echo "âš ï¸ Tag $version already exists for main project"
          else
            git tag "$version"
            echo "âœ… Created main project tag: $version"
          fi

      - name: ğŸ·ï¸ Create backend tags
        if: ${{ needs.validate-inputs.outputs.release_type == 'backends' || needs.validate-inputs.outputs.release_type == 'core+backends' }}
        run: |
          version="${{ needs.validate-inputs.outputs.version }}"
          backends='${{ needs.discover-backends.outputs.backends }}'
          
          echo "Creating backend tags for version: $version"
          
          # Parse backends JSON array
          echo "$backends" | jq -r '.[]' | while read -r backend; do
            backend_tag="backend/${backend}/${version}"
            
            # Check if tag already exists
            if git tag -l | grep -q "^${backend_tag}$"; then
              echo "âš ï¸ Tag $backend_tag already exists"
            else
              git tag "$backend_tag"
              echo "âœ… Created backend tag: $backend_tag"
            fi
          done

      - name: ğŸš€ Push main project tag
        if: ${{ needs.validate-inputs.outputs.release_type == 'core' || needs.validate-inputs.outputs.release_type == 'core+backends' }}
        run: |
          version="${{ needs.validate-inputs.outputs.version }}"
          
          echo "Pushing main project tag..."
          git push origin "$version" || echo "âš ï¸ Main project tag $version may already exist remotely"
          echo "ğŸ“¤ Pushed main project tag: $version"

      - name: ğŸš€ Push backend tags
        if: ${{ needs.validate-inputs.outputs.release_type == 'backends' || needs.validate-inputs.outputs.release_type == 'core+backends' }}
        run: |
          version="${{ needs.validate-inputs.outputs.version }}"
          
          echo "Pushing backend tags..."
          backends='${{ needs.discover-backends.outputs.backends }}'
          echo "$backends" | jq -r '.[]' | while read -r backend; do
            backend_tag="backend/${backend}/${version}"
            git push origin "$backend_tag" || echo "âš ï¸ Backend tag $backend_tag may already exist remotely"
            echo "ğŸ“¤ Pushed: $backend_tag"
          done
          
          echo "ğŸ‰ All backend tags pushed successfully!"

  deploy-docs:
    name: ğŸ“š Deploy Documentation
    needs: [validate-inputs, create-tags]
    if: ${{ needs.validate-inputs.outputs.publish_docs == 'true' && (needs.validate-inputs.outputs.release_type == 'core' || needs.validate-inputs.outputs.release_type == 'core+backends') }}
    uses: ./.github/workflows/deploy-docs.yml
    with:
      version: ${{ needs.validate-inputs.outputs.version }}
    secrets: inherit